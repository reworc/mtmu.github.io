<!DOCTYPE html>
<html lang="DE-de">
  <head>
    <!-- Load d3.js -->
    <script src="https://d3js.org/d3.v6.js"></script>
    <title>D3 Dev page</title>
  </head>
  <body>
    <h1>Statistiken</h1>
    <h2>Publikationen nach Jahr</h2>
    <div id="dataVis_numPubYear">
    </div>
    <h2>Co-Authoren</h2>
    <div class="visualization__authors">
    <div class="visualization__authors--buttons">
        <p>Sortierung</p>
        <fieldset>
          <input type="radio" id="d" name="sort" value="0" onchange="drawAuthors(url, this.value)">
          <label for="d">Datum (neuste zuerst)</label> 
          <input type="radio" id="h" name="sort" value="1" onchange="drawAuthors(url, this.value)" checked>
          <label for="h">Häufigkeit</label>
          <input type="radio" id="n" name="sort" value="2" onchange="drawAuthors(url, this.value)">
          <label for="n">Name</label> 
        </fieldset>
      </div>
      <div class="visualization__authors--diagram" id="dataVis_Authors">
      </div>
    </div>
    <h2>Co-Author Timline</h2>
    <div class="visualization__authors--diagram" id="dataVis_AuthorPeriod"></div>
    <h2>Keywords</h2>
    <div id="dataVis_Keywords"></div>

    
    
    <script>
      Array.prototype.max = function() {
        return Math.max.apply(null, this);
      };

      Array.prototype.min = function() {
        return Math.min.apply(null, this);
      };

      const extractAuthors = (authorString) => 
      {
        const authorRegex = /([^,&]+)(, | & )?/g;

        var arr = authorString.split(/[/,|&]+/);
        return arr.map((s) => s.trim());
      };

      const arrayRange = (start, stop, step) => 
        Array.from(
          { length: (stop - start) / step + 1 },
          (value, index) => start + index * step
      );

      /// draw d3.js bar plot of publications
      const drawPublications = (url) => {  
        // set the dimensions and margins of the graph
        const margin = {top: 30, right: 30, bottom: 70, left: 60},
            width = 800 - margin.left - margin.right,
            height = 300 - margin.top - margin.bottom;
        
        // append the svg object to the body of the page
        const svg = d3.select("#dataVis_numPubYear")
          .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
          .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);
        
        // Parse the Data
        d3.json(url).then( function(data) {
        
          const minYear = data.years.map(d => d.name).min();
          const maxYear = data.years.map(d => d.name).max();

          const arrayYears = arrayRange(minYear, maxYear, 1);

          // X axis
          const x = d3.scaleBand()
              .range([ 0, width ])
              .domain(arrayYears)
              .padding(0.6);
            svg.append("g")
              .attr("transform", `translate(0, ${height})`)
              .call(d3.axisBottom(x))
              .selectAll("text")
                .attr("transform", "translate(-10,0)rotate(-45)")
                .style("text-anchor", "end");

          const maxPublications = data.years.map((y) => y.elements.length).max();

          // Add Y axis
          let y = d3.scaleLinear()
            .domain([0, maxPublications])
            .range([ height, 0]);
          svg.append("g")
            .call(d3.axisLeft(y).ticks(maxPublications).tickFormat(d3.format("d"))
          );

          // Bars - start height with 0: correct height is set in animation
          svg.selectAll("mybar")
            .data(data.years)
            .join("rect")
              .attr("x", d => x(d.name))
              .attr("width", x.bandwidth())
              .attr("fill", barColor)
              .attr("height", function(d) { return height - y(0); }) // always equal to 0
              .attr("y", function(d) { return y(0); });

          // Animation
          svg.selectAll("rect")
            .transition()
            .duration(800)
            .attr("y", d => y(d.elements.length))
            .attr("height", d => height - y(d.elements.length))
            .delay((d,i) => i*100 );     
        });
      };

      /// draw horizontal d3 bar plot with number of publications per co-author
      /// can be sorted (@param order) by time (descending, 0), publication count (1) or name (2)
      const drawAuthors = (url, order) => {
        
        // set the dimensions and margins of the graph
        const marginAuthors = {top: 30, right: 30, bottom: 70, left: 200},
            width2 = 800 - marginAuthors.left - marginAuthors.right,
            height2 = 800 - marginAuthors.top - marginAuthors.bottom;
        d3.select("#dataVis_Authors").selectAll("*").remove();

        const svg = d3.select("#dataVis_Authors")
        .append("svg")
          .attr("width", width2 + marginAuthors.left + marginAuthors.right)
          .attr("height", height2 + marginAuthors.top + marginAuthors.bottom)
        .append("g")
          .attr("transform", `translate(${marginAuthors.left},${marginAuthors.top})`);

        // Parse the Data
        d3.json(url).then( function(data) {

          var dict = new Map(); 

          data.years.forEach((y) => {
            y.elements.forEach((e) => { 

              var authors = extractAuthors(e.authors);
              authors.forEach((a) => {
                if (dict.has(a)) {
                  let num = dict.get(a);
                  dict.set(a, num + 1);
                } else {
                  dict.set(a, 1);
                }
              });
            });
          });

          // delete myself
          dict.delete("Mathias Müller");
          
          // if param is 1 or 2: sort map
          let sorted = dict; 
          if (Number(order) === 1) {
            sorted = new Map([...dict].sort((a,b) => b[1] - a[1]));
          } else if (Number(order) === 2 ) {
            sorted = new Map([...dict].sort((a,b) => a[0].localeCompare(b[0])));
          }

          // get the highest number of co-authored publications
          const maxNum = Array.from(sorted.values()).max(); 
          
          // X axis
          let x = d3.scaleLinear()
            .domain([0, maxNum])
            .range([ 0, width2]);

          svg.append("g")
            .attr("transform", `translate(0, ${height2})`)
            .call(d3.axisBottom(x).ticks(maxNum).tickFormat(d3.format("d")))
            .selectAll("text")
            .attr("transform", "translate(-10,0)rotate(-45)")
            .style("text-anchor", "end");

          // Y axis
          const y = d3.scaleBand()
                    .range([ 0, height2 ])
                    .domain(Array.from(sorted.keys()))
                    .padding(0.2);

          svg.append("g")
            .call(d3.axisLeft(y));

          // Bars
          svg.selectAll("mybar")
            .data(Array.from(sorted))
            .join("rect")
              .attr("x", d => 0)
              .attr("y", d => y(d[0]))
              .attr("height", y.bandwidth())
              .attr("width", d => 0)
              .attr("fill", barColor);
              
          // Animation
          svg.selectAll("rect")
            .transition()
            .duration(800)
            .attr("x", d => 0)
            .attr("width", d => x(d[1]))
            .delay((d,i) => i*50 );     
        });
      };

      // draw a special bar plot visualizing the time between fist and last publication with a co-author
      // bars start at the first year and end at te last year
      // bars have circle at the start and the end, so that co-authors who appear only once are visible
      const drawAuthorPeriod = (url) => {
        
        // set the dimensions and margins of the graph
        const marginAuthors = {top: 30, right: 30, bottom: 70, left: 200},
            width2 = 800 - marginAuthors.left - marginAuthors.right,
            height2 = 800 - marginAuthors.top - marginAuthors.bottom;

        const svg = d3.select("#dataVis_AuthorPeriod")
        .append("svg")
          .attr("width", width2 + marginAuthors.left + marginAuthors.right)
          .attr("height", height2 + marginAuthors.top + marginAuthors.bottom)
        .append("g")
          .attr("transform", `translate(${marginAuthors.left},${marginAuthors.top})`);

        // Parse the Data
        d3.json(url).then( function(data) {

          var dict = new Map(); 

          data.years.forEach((y) => {
            y.elements.forEach((e) => { 

              var authors = extractAuthors(e.authors);
              authors.forEach((a) => {
                if (dict.has(a)) {
                  let entry = dict.get(a);
                  dict.set(a, {number: entry.number + 1, minYear: Number(y.name), maxYear: Number(entry.maxYear) });
                } else {
                  dict.set(a, { number: 1, minYear: Number(y.name), maxYear: Number(y.name)});
                }
              });
            });
          });

          dict.delete("Mathias Müller");
          const sorted = new Map([...dict].sort((a,b) => a[0].localeCompare(b[0])));
          const maxYear = Array.from(sorted.values()).map(v => v.maxYear).max(); 
          const minYear = Array.from(sorted.values()).map(v => v.minYear).min(); 
          
          // X axis: start half a year early so that teh circle does not overlap the y-axis
          let x = d3.scaleLinear()
            .domain([minYear - 0.5, maxYear])
            .range([0, width2]);
          svg.append("g")
            .attr("transform", `translate(0, ${height2})`)
            .call(d3.axisBottom(x).ticks(maxYear-minYear).tickFormat(d3.format("d")))
            .selectAll("text")
            .attr("transform", "translate(-10,0)rotate(-45)")
            .style("text-anchor", "end");

          // Y axis
          const y = d3.scaleBand()
                    .range([ 0, height2 ])
                    .domain(Array.from(sorted.keys()))
                    .padding(0.2);

          svg.append("g")
            .call(d3.axisLeft(y));

          // Bars
          svg.selectAll("mybar")
            .data(Array.from(sorted))
            .join("rect")
              .attr("x", d => x(d[1].minYear))
              .attr("y", d => y(d[0]))
              .attr("height", y.bandwidth())
              .attr("width", d => x(d[1].maxYear) - x(d[1].minYear))
              .attr("fill", barColor2);

          const circleRadius = 0.5 * y.bandwidth();

          // Circles of variable 1
          svg.selectAll("mycircle")
            .data(Array.from(sorted))
            .enter()
            .append("circle")
              .attr("cx", d => x(d[1].minYear))
              .attr("cy", d => y(d[0]) + circleRadius)
              .attr("r", `${circleRadius}`)
              .style("fill", circleColor)
              .style("stroke", circleOutline)
              .style("stroke-width", "2");

          // Circles of variable 2
          svg.selectAll("mycircle")
            .data(Array.from(sorted))
            .enter()
            .append("circle")
              .attr("cx", d => x(d[1].maxYear))
              .attr("cy", d => y(d[0])+ circleRadius)
              .attr("r", `${circleRadius}`)
              .style("fill", circleColor)
              .style("stroke", circleOutline)
              .style("stroke-width", "2");
          });
        };

      // horizontal bar plot visualizing how often specific key words were used
      // ordered by number of appearances
      const drawKeywords = (url, order) => {
        
        // set the dimensions and margins of the graph
        const marginKeywords = {top: 30, right: 30, bottom: 70, left: 200},
            width2 = 800 - marginKeywords.left - marginKeywords.right,
            height2 = 800 - marginKeywords.top - marginKeywords.bottom;
        d3.select("#dataVis_Keywords").selectAll("*").remove();

        const svg = d3.select("#dataVis_Keywords")
        .append("svg")
          .attr("width", width2 + marginKeywords.left + marginKeywords.right)
          .attr("height", height2 + marginKeywords.top + marginKeywords.bottom)
        .append("g")
          .attr("transform", `translate(${marginKeywords.left},${marginKeywords.top})`);

        // Parse the Data
        d3.json(url).then( function(data) {

          var dict = new Map(); 

          data.years.forEach((y) => {
            y.elements.forEach((e) => { 

              var keywords = e.keywords;
              keywords.forEach((k) => {
                if (dict.has(k)) {
                  let num = dict.get(k);
                  dict.set(k, num + 1);
                } else {
                  dict.set(k, 1);
                }
              });
            });
          });

          let sorted = dict; 
          if (Number(order) === 1) {
            sorted = new Map([...dict].sort((a,b) => b[1] - a[1]));
          } else if (Number(order) === 2 ) {
            sorted = new Map([...dict].sort((a,b) => a[0].localeCompare(b[0])));
          }

          const maxNum = Array.from(sorted.values()).max(); 
            
          // X axis
          let x = d3.scaleLinear()
            .domain([0, maxNum])
            .range([ 0, width2]);
          svg.append("g")
            .attr("transform", `translate(0, ${height2})`)
            .call(d3.axisBottom(x).ticks(maxNum).tickFormat(d3.format("d")))
            .selectAll("text")
            .attr("transform", "translate(-10,0)rotate(-45)")
            .style("text-anchor", "end");

          // Y axis
          const y = d3.scaleBand()
                    .range([ 0, height2 ])
                    .domain(Array.from(sorted.keys()))
                    .padding(0.2);

          svg.append("g")
            .call(d3.axisLeft(y));

          // Bars
          svg.selectAll("mybar")
            .data(Array.from(sorted))
            .join("rect")
              .attr("x", d => 0)
              .attr("y", d => y(d[0]))
              .attr("height", y.bandwidth())
              .attr("width", d => 0)
              .attr("fill", barColor);

          // Animation
          svg.selectAll("rect")
            .transition()
            .duration(800)
            .attr("x", d => 0)
            .attr("width", d => x(d[1]))
            .delay((d,i) => i*20 );     
          });
        };

        const barColor = "#0084ba";
        const barColor2 = "#aaa"
        const circleColor = "#0084ba";
        const circleOutline = "#fff";

        const url = "https://reworc.github.io/mtmu.github.io/assets/data/publications.json";
        
        drawPublications(url);
        drawAuthors(url, 1);
        drawAuthorPeriod(url);
        drawKeywords(url, 1);

      </script>
  </body>
</html>